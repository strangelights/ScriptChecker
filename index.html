<!DOCTYPE html>
<html lang="en">
  <head>

    <!-- Basic Page Needs
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>ScriptChecker - Get Scripty</title>
    <meta name="description" content="ScriptChecker is a utility that exposes any MailChimp-specific technologies used on websites">
    <meta name="author" content="Josh Brookshire">

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONTS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/carousel.css">

    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="images/script-favicon.png">

    <!-- Load Jquery
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

</head>
<body>
  <div>
    <main>
    <!-- DARK THEME TESTING
    –––––––––––––––––––––––––––––––––––––––––––––––––– 

  <div class="button" id="btn">Dark Mode</div> 

  -->


    <!-- Heading
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <div class="main-section">
      <br>
        <div class="container">
          <div class="row">
            <div class="main-column">
              <h1 class="main-heading">ScriptChecker</h1>
              <h6>ScriptChecker is a utility that exposes MailChimp-specific technologies used on websites.<br>
                It detects Connected Sites "mcjs" code, popup forms, embedded forms, account identification,e-commerce platforms, Google Analytics, and more.
              </h6>
            </div>
          </div>
        </div>
    </div>
    <br>
    
    <!-- Form
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    
    <div class="form-section">
      <form id="siteForm" action="" method="POST">
          <span>Enter URL:&nbsp;</span>
          <input id="siteURL" type="url" name="siteURL" placeholder="https://example.com" maxlength="128" required="required"> 
          <span>&nbsp;</span>
          <input class="button-primary" type= "submit" name="submit" onclick="" value= "Check it!">
      </form>
      <div id="errorDisplay"></div>                  <!-- WHERE AJAX WILL DUMP THE GOODS -->
    </div>
    

  <!-- AJAX CALL AND RETURN
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

  <script type="text/javascript"> 
    var $formURL,
        $curlResponse,
        $tempDiv,
        $checkMCJS;

   //-----------Returning UID------------

    function findUID(){
      var $mcjsElement = $doc.getElementById('mcjs'); // checks for standard Connected Sites script (not Shopify version)
      if ($mcjsElement == null){
        alert("UID NOT FOUND");
          var $head = $doc.head.innerHTML;
          var $mcjs = $head.match(/mcjs/);
      } else{
      var $mcjsTextContent = $mcjsElement.textContent;
      var $mcjsSplit = $mcjsTextContent.split("/");
      var $mcjsUID = $mcjsSplit[6]
      var $length = $mcjsUID.length;
      if ($length == 25){
        var $uid = document.getElementById("myTable").rows[1].cells;
        $uid[1].innerHTML = '<a href="https://us1.admin.mailchimp.com/peaches2/tools/user-search/results?q=' + $mcjsUID + '" ' + 'target="_blank">' + $mcjsUID + '</a>';
              } 
            }  
    }

   //-----------Connect Sites Script-----------

      function findMCJS(){
        var $head = $doc.head.innerHTML;
        var $mcjs = $head.match(/mcjs/);
        if ($mcjs == "mcjs"){
          var $mcjsFound = document.getElementById("myTable").rows[2].cells;
          $mcjsFound[1].innerHTML = "YES";
        } else if ($mcjs == null){
          var $mcjsNotFound = document.getElementById("myTable").rows[2].cells;
          $mcjsNotFound[1].innerHTML = "NOT FOUND";
        }

      }
  
    //----------Popup Script------------
    
    function findPopup(){
      var $body = $doc.body.innerHTML;
      var $popupForm = $body.match(/signup-forms\/popup\/embed.js/); // MC Pop Up Form code
      if ($popupForm == "signup-forms/popup/embed.js"){
        var $popupFound = document.getElementById("myTable").rows[3].cells;
        $popupFound[1].innerHTML = "YES";
      } else if ($popupForm == null){
          var $popupNotFound = document.getElementById("myTable").rows[3].cells;
        $popupNotFound[1].innerHTML = "NOT FOUND";
      }
    } // TO DO: CONFIRM IF POPUP FORM CAN BE IN HEAD AS WELL AND ADD IF STATEMENT FOR SCENARIO


    //-----------Embedded Script-----------

    function findEmbedded(){
      var $body = $doc.body.innerHTML;
      var $embeddedForm = $body.match(/mc-embed/); // MC Embedded Form script
      if ($embeddedForm == 'mc-embed') {
        var $embeddedFound = document.getElementById("myTable").rows[4].cells;
        $embeddedFound[1].innerHTML = "YES";
      }
      else if ($embeddedForm == null) {
        var $embeddedNotFound = document.getElementById("myTable").rows[4].cells;
        $embeddedNotFound[1].innerHTML = "NOT FOUND";
      }
    }
   

     // add integration detection - maybe change to platform detection?
     // link to star search for each integration
     // add google analytics to index page
  



  // AJAX FORM SUBMISSION TESTING    // So this works to override the html5 form submission above see p.395 of Duckett
    $("#siteForm").on("submit", function(e){  // on form submission call the function
      e.preventDefault();                 // prevent the html form's submit action from occurring
      $formURL = $("#siteForm").serialize();
      $.ajax({
        url : 'php/proxy.php',
        type : 'POST',
        data : $formURL,
        success : function (data) {
          $curlResponse = data; // pass server data back into variable
					$parser = new DOMParser();
					$doc = $parser.parseFromString($curlResponse, "text/html");
          console.log($doc);
          findUID();
          findMCJS();
          findPopup();
          findEmbedded();
        
          //----------Error Process------------

          },
        error : function () {
           alert("There was an error. Please try again.");
          }
        });
      });

  
  </script>



  <!-- POPULATE TABLE TESTING (SAFE TO REMOVE)
 

  <div style="text-align:center;">
    <button onclick="myFunction2()">populate form test</button>
  </div>

   –––––––––––––––––––––––––––––––––––––––––––––––––– -->

  <script>
  function myFunction2() {
      var uid = document.getElementById("myTable").rows[1].cells;
      uid[1].innerHTML = '<a href="https://us1.admin.mailchimp.com/peaches2/tools/user-search/results?q=" target="_blank"></a>';
      var mcjs = document.getElementById("myTable").rows[2].cells;
      mcjs[1].innerHTML = "YES";
      var pop = document.getElementById("myTable").rows[3].cells;
      pop[1].innerHTML = "NO";
      var embedded = document.getElementById("myTable").rows[4].cells;
      embedded[1].innerHTML = "YES";
      var ecomm = document.getElementById("myTable").rows[5].cells;
      ecomm [1].innerHTML = "Shopify";
      var ga = document.getElementById("myTable").rows[6].cells;
      ga[1].innerHTML = "GA-1234567890";
  }
  </script>

    <!-- Table -- EXPERIMENTAL
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <div class="table-section">
      <div class="container">
        <div class="table">
          <table id="myTable" class="u-full-width">
              <thead>
                <tr>
                  <th></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>User ID</td>
                  <td headers="UID">??</td>
                </tr>
                <tr>
                  <td>MCJS</td>
                  <td headers="MCJS">??</td>
                </tr>
                <tr>
                  <td>Popup Form</td>
                  <td headers="popup">??</td>
                </tr>
                <tr>
                  <td>Embedded Form</td>
                  <td headers="embedded">??</td>
                </tr>
                <tr>
                  <td>Integration</td>
                  <td headers="ecomm">Coming Soon!</td>
                </tr>
                <tr>
                  <td>Google Analytics</td>
                  <td headers="GA">Coming Soon!</td>
                </tr>
              </tbody>
          </table>
        </div>
      </div>
    </div>  
    <!-- Footer links
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
   <!--
    <div class="columns">
      <div class="container">
        <div class="row">
          <div class="one-third column value" style="text-align:center;">
            <p><a href="mailto:jbrookshire@rsglab.com?subject=ScriptChecker%20Bug%20Report">Report an issue</a></p>
          </div>
          <div class="one-third column value" style="text-align:center;">
            <a href="https://github.com/strangelights/ScriptChecker" target="_blank">GitHub</a>
          </div>
          <div class="one-third column value" style="text-align:center;">
            <a href="https://asta.rsglab.com/projects/SpeedRacer/12monkeys/" target="_blank">S.T.A.R. Search</a>
          </div>
        </div>
      </div>
    </div>
    -->
    </main>
    <footer>
      <div class="footer">
       <a href="https://github.com/strangelights/highlighter"><img src="https://image.flaticon.com/icons/svg/25/25231.svg" alt="GitHub Logo" title="Git in the car nerd!" style="height:25px;">
          <p><a href="mailto:jbrookshire@rsglab.com?subject=ScriptChecker%20Bug%20Report">Report an issue</a></p>
      </div>
    </footer>
    </div>
  </body>
</html>
